@using Strem.Infrastructure.Services.Api
@using Strem.Portals.Data
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components
@using Strem.Core.Events.Bus
@using Strem.Core.Extensions
@using Strem.Core.Services.Browsers.Web
@using Strem.Core.Types
@using Strem.Portals.Data.Overrides
@using Strem.Portals.Events
@using Strem.Portals.Extensions
@using Strem.Portals.Types
@using Strem.Todos.Data
@using Strem.Todos.Services.Stores

@inject IWebBrowser WebBrowser
@inject IEventBus EventBus
@inject ITodoStore TodoStore 
@inject ButtonRuntimeStyles ButtonRuntimeStyles 

<div class="box">
    <div class="field is-grouped">
        <div class="control">
            <h3 class="title is-3 has-text-black">Editing @Portal.Name</h3>
        </div>
        <div class="control is-expanded">
            <button class="button is-primary is-pulled-right" @onclick="ViewPortalInBrowser">
                <span class="icon is-small">
                    <i class="fas fa-globe"></i>
                </span>
                <span>View In Browser</span>
            </button>
        </div>
    </div>
    <PortalDetailsEditor Data="Portal" DataChanged="PortalDetailsChanged" />
</div>

<div class="columns">
    <div class="column">
        <div class="box">
            <div class="portal-page portal-editor">
                <div class="is-flex is-flex-direction-row is-flex-wrap-wrap">
                    @for (var i = 0; i < Portal.ButtonGridSize; i++)
                    {
                        var possibleButton = GetButtonAt(i);
                        if (possibleButton == null)
                        {
                            <PlaceholderButton ButtonSize="Portal.ButtonSize" GridIndex="i" ButtonPressed="AddButton">
                                <span class="icon fa-3x m-auto">
                                    <i class="fas fa-plus has-text-white"></i>
                                </span>
                                <label class="label has-text-white">Add Button</label>
                            </PlaceholderButton>
                        }
                        else
                        {
                            <PortalButton ButtonId="possibleButton.Id" ButtonStyles="possibleButton.DefaultStyles" ButtonPressed="EditButton" ButtonSize="Portal.ButtonSize"/>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
    @if (Portal.ShowTodos)
    {
        var filteredTodos = GetFilteredTodos().ToArray();
        if (filteredTodos.Length > 0)
        {
            <div class="column is-one-half todo-section">
                <div class="box">
                    <PagedContent Data="filteredTodos" ElementsPerPage="5" Context="Todo" OrderBy="x => x.ExpiryDate">
                        <TodoEntry Todo="Todo" CanRemove="false"></TodoEntry>
                    </PagedContent>
                </div>
            </div>
        }
    }
</div>


<Modal IsVisible="ShowButtonEditModal">
    @if (SelectedButton != null)
    {
        <PortalButtonEditor Data="SelectedButton" OnClosed="ButtonEditModalClosed" RequestedDeletion="DeleteButton"></PortalButtonEditor>
    }
</Modal>

@code {
    [Parameter]
    public PortalData Portal { get; set; } = new();
    
    [Parameter]
    public EventCallback<Guid> RequestingDeletion { get; set; }

    public ButtonData SelectedButton { get; set; }
    public bool ShowButtonEditModal { get; set; }
    public bool ShowDeletionModal { get; set; }
    
    public void AddButton(int gridIndex)
    {
        var button = new ButtonData { GridIndex = gridIndex };
        Portal.Buttons.Add(button);
        EditButton(button.Id);
    }

    public void EditButton(Guid buttonId)
    {
        var button = Portal.Buttons.SingleOrDefault(x => x.Id == buttonId);
        if(button == null) { return; }
        
        SelectedButton = button;
        ShowButtonEditModal = true;
    }

    public void ViewPortalInBrowser()
    {
        var portalUrl = $"http://localhost:{InternalWebHostConfiguration.ApiHostPort}/portals/{Portal.Id}";
        WebBrowser.LoadUrl(portalUrl);
    }

    public IEnumerable<TodoData> GetFilteredTodos()
    {
        if (Portal.TodoTags.Count == 0)
        { return TodoStore.Data; }

        return TodoStore.Data
            .Where(x => Portal.TodoTags.All(requiredTag => x.Tags.Contains(requiredTag, StringComparer.OrdinalIgnoreCase)));
    }
    
    private void ButtonEditModalClosed()
    {
        ShowButtonEditModal = false;
        EventBus.PublishAsync(new PortalButtonChangedEvent(Portal.Id, SelectedButton.Id));
        ButtonRuntimeStyles.RefreshStylesFor(Portal.Id, SelectedButton);
        SelectedButton = null;
    }

    private void PortalDetailsChanged()
    {
        InvokeAsync(StateHasChanged);
        EventBus.PublishAsync(new PortalChangedEvent(Portal.Id));
    }

    private void DeleteButton(Guid obj)
    {
        ShowButtonEditModal = false;
        Portal.Buttons.Remove(SelectedButton);
        SelectedButton = null;
        EventBus.PublishAsync(new PortalChangedEvent(Portal.Id));
    }

    private void DeletionModalClosed()
    { ShowDeletionModal = false; }

    private void OnPortalDeletion()
    { RequestingDeletion.InvokeAsync(Portal.Id); }

    private ButtonData? GetButtonAt(int gridIndex)
    {return Portal.Buttons.FirstOrDefault(x => x.GridIndex == gridIndex);}

}